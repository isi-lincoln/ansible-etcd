# etcd setup
# requires: ansible-galaxy collection install community.docker
---

- name: docker pull etcd image
  command: docker pull bitnami/etcd:{{ version }}
  #community.docker.docker_image_pull:
  #  name: "bitnami/etcd:{{ version }}"
  #  platform: amd64

- name: ensure etcd config dir
  file:
    path: /etc/etcd
    state: directory
    owner: etcd
    group: etcd

- name: copy certs
  copy:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
  with_items:
    - src: "{{ca_pem}}"
      dest: /etc/etcd/ca.pem

    - src: "{{db_pem}}"
      dest: /etc/etcd/db.pem

    - src: "{{db_key}}"
      dest: /etc/etcd/db-key.pem
  when: not keygen

- name: disable default etcd instance
  systemd:
    name: etcd
    enabled: no
    state: stopped
